<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Learning Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #333; margin-bottom: 10px; text-align: center; }
        .mode-selector {
            display: flex; gap: 10px; margin-bottom: 30px;
            background: #f0f0f0; padding: 5px; border-radius: 10px;
        }
        .mode-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: bold; cursor: pointer;
            background: transparent; transition: all 0.3s;
        }
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .mode-content { display: none; }
        .mode-content.active { display: block; }
        .input-group { margin-bottom: 20px; }
        textarea {
            width: 100%; padding: 15px; border: 2px solid #ddd;
            border-radius: 10px; font-size: 16px; resize: vertical;
            min-height: 100px; font-family: inherit;
        }
        textarea:focus { outline: none; border-color: #667eea; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button {
            flex: 1; padding: 15px; border: none; border-radius: 10px;
            font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;
            min-width: 150px;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4); }
        .btn-listen { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        .btn-listen:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; }
        .btn-warning:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4); }
        .btn-info { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; }
        .btn-info:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        .result {
            background: #f8f9fa; border-radius: 10px; padding: 20px;
            margin-top: 20px; white-space: pre-wrap; line-height: 1.6; display: none;
        }
        .result.show { display: block; }
        .loading { text-align: center; color: #667eea; font-weight: bold; }
        .error { background: #fee; color: #c33; padding: 15px; border-radius: 10px; margin-top: 20px; display: none; }
        .error.show { display: block; }
        .recording-indicator {
            display: none; text-align: center; padding: 10px; background: #ffebee;
            border-radius: 8px; margin-bottom: 15px; color: #c62828;
            font-weight: bold; animation: pulse 1.5s infinite;
        }
        .recording-indicator.active { display: block; }
        .listening-indicator {
            display: none; text-align: center; padding: 10px; background: #e3f2fd;
            border-radius: 8px; margin-bottom: 15px; color: #1976d2;
            font-weight: bold; animation: pulse 1.5s infinite;
        }
        .listening-indicator.active { display: block; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .practice-guide {
            background: #fff9e6; border-left: 4px solid #ffc107;
            padding: 15px; margin-bottom: 20px; border-radius: 5px; font-size: 14px;
        }
        .practice-guide h3 { color: #f57c00; margin-bottom: 10px; font-size: 16px; }
        .practice-guide ol { margin-left: 20px; line-height: 1.8; }
        .practice-guide strong { color: #e65100; }
        .feedback-container { background: white; border-radius: 10px; padding: 20px; margin-top: 20px; }
        .accuracy-score {
            text-align: center; padding: 20px;
            color: white; border-radius: 10px; margin-bottom: 20px;
        }
        .accuracy-score h2 { font-size: 48px; margin: 0; }
        .accuracy-score p { margin: 5px 0 0 0; font-size: 18px; }
        .word-analysis { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .word-box {
            padding: 10px 15px; border-radius: 8px;
            font-weight: bold; font-size: 16px; transition: all 0.3s;
        }
        .word-correct { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .word-incorrect { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .word-missing { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        .text-display {
            background: #fff; border: 2px solid #ddd; border-radius: 10px;
            padding: 20px; margin: 20px 0; line-height: 1.8;
            font-size: 16px; max-height: 400px; overflow-y: auto;
        }
        .word-highlight {
            background: #fff9c4; padding: 2px 4px; border-radius: 3px;
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .word-highlight:hover { background: #ffeb3b; transform: scale(1.05); }
        .tooltip {
            position: fixed; background: #333; color: white;
            padding: 12px 16px; border-radius: 8px; font-size: 14px;
            max-width: 300px; z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none; white-space: pre-wrap; line-height: 1.5;
        }
        .tooltip.show { display: block; }
        .info-box {
            background: #e3f2fd; border-left: 4px solid #2196f3;
            padding: 15px; margin: 15px 0; border-radius: 5px; font-size: 14px;
        }
        .timer { text-align: center; font-size: 24px; font-weight: bold; color: #c62828; padding: 10px; }
        .live-transcript {
            background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px;
            padding: 15px; margin-bottom: 15px; min-height: 60px;
            font-size: 16px; line-height: 1.6; display: none;
        }
        .live-transcript.active { display: block; }
        .live-transcript strong { color: #2e7d32; display: block; margin-bottom: 5px; }
        #transcriptText {
            color: #1b5e20;
            font-weight: 500;
        }
        .vocab-list {
            background: #fff; border: 2px solid #9b59b6; border-radius: 10px;
            padding: 20px; margin: 20px 0; display: none;
        }
        .vocab-list.show { display: block; }
        .vocab-list h3 { color: #8e44ad; margin-bottom: 15px; }
        .vocab-item {
            background: #f8f9fa; border-left: 4px solid #9b59b6;
            padding: 12px; margin-bottom: 10px; border-radius: 5px;
        }
        .vocab-item strong { color: #8e44ad; font-size: 18px; }
        .vocab-item p { margin: 5px 0 0 0; color: #555; line-height: 1.5; }
        .vocab-empty { text-align: center; color: #999; padding: 20px; font-style: italic; }
        .question-box {
            background: #fff; border: 2px solid #3498db; border-radius: 10px;
            padding: 20px; margin: 20px 0; display: none;
        }
        .question-box.show { display: block; }
        .question-item {
            background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .question-item h4 { color: #2980b9; margin-bottom: 10px; }
        .question-input {
            width: 100%; padding: 10px; border: 2px solid #ddd;
            border-radius: 5px; font-size: 14px; margin-top: 8px;
        }
        .question-input:focus { outline: none; border-color: #3498db; }
        .answer-feedback {
            margin-top: 10px; padding: 10px; border-radius: 5px; font-weight: bold;
            display: none;
        }
        .answer-feedback.show { display: block; }
        .answer-correct { background: #d4edda; color: #155724; }
        .answer-incorrect { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö AI Learning Assistant</h1>
        
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="pronunciation">üó£Ô∏è Pronunciation</button>
            <button class="mode-btn" data-mode="reading">üìñ Reading Comprehension</button>
        </div>

        <div class="mode-content active" id="pronunciation-mode">
            <div class="practice-guide">
                <h3>üìù Practice Steps:</h3>
                <ol>
                    <li><strong>Listen to Model</strong> - Dengar pronunciation yang benar</li>
                    <li><strong>Record Your Voice</strong> - Baca text dan rekam sampai selesai</li>
                    <li><strong>Stop Recording</strong> - Klik stop setelah selesai</li>
                    <li><strong>Check Pronunciation</strong> - Dapatkan feedback AI</li>
                </ol>
            </div>

            <div class="listening-indicator" id="listeningIndicator">
                üîä Playing model audio... Listen carefully!
            </div>

            <div class="recording-indicator" id="recordingIndicator">
                <div class="timer" id="recordingTimer">00:00</div>
                üî¥ Recording... Click "Stop Recording" when done
            </div>

            <div class="live-transcript" id="liveTranscript">
                <strong>üéôÔ∏è What you're saying (Real-time):</strong>
                <div id="transcriptText">Waiting for speech...</div>
            </div>
            
            <div class="input-group">
                <textarea id="phraseInput" placeholder="Type a phrase to practice pronunciation...">Hello, how are you today? I am learning English pronunciation.</textarea>
            </div>
            
            <div class="btn-group">
                <button class="btn-listen" id="listenBtn">üîä Listen to Model</button>
                <button class="btn-success" id="recordBtn">üé§ Start Recording</button>
                <button class="btn-danger" id="stopBtn" style="display:none;">‚èπÔ∏è Stop Recording</button>
            </div>

            <div class="btn-group">
                <button class="btn-primary" id="checkBtn">‚úÖ Check Pronunciation</button>
            </div>
            
            <div class="result" id="pronunciationResult"></div>
            <div class="error" id="pronunciationError"></div>
        </div>

        <div class="mode-content" id="reading-mode">
            <div class="info-box">
                üí° <strong>Cara Pakai:</strong> Paste teks bahasa Inggris, klik kata yang sulit untuk terjemahan, atau gunakan fitur AI!
            </div>
            
            <div class="input-group">
                <textarea id="readingInput" placeholder="Paste your English text here..." rows="6">The Amazon rainforest is the largest tropical rainforest in the world. It covers much of northwestern Brazil and extends into Colombia, Peru and other South American countries. Scientists believe that millions of species still remain undiscovered in the Amazon.</textarea>
            </div>
            
            <div class="btn-group">
                <button class="btn-primary" id="analyzeBtn">üîç Analyze Text</button>
                <button class="btn-success" id="summaryBtn" style="display:none;">üìù Summary</button>
                <button class="btn-warning" id="translateBtn" style="display:none;">üåê Translate</button>
                <button class="btn-info" id="questionsBtn" style="display:none;">‚ùì Questions</button>
                <button class="btn-secondary" id="vocabBtn" style="display:none;">üìö My Vocabulary</button>
            </div>
            
            <div class="text-display" id="textDisplay" style="display:none;"></div>
            
            <div class="vocab-list" id="vocabList">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>üìö My Vocabulary List</h3>
                    <button class="btn-danger" id="clearVocabBtn" style="padding: 8px 15px; font-size: 14px;">üóëÔ∏è Clear All</button>
                </div>
                <div id="vocabContainer"></div>
            </div>
            
            <div class="question-box" id="questionBox">
                <h3 style="color: #2980b9; margin-bottom: 15px;">‚ùì Comprehension Questions</h3>
                <div id="questionsContainer"></div>
                <button class="btn-primary" id="checkAnswersBtn" style="margin-top: 15px; display: none;">‚úÖ Check Answers</button>
            </div>
            
            <div class="result" id="readingResult"></div>
            <div class="error" id="readingError"></div>
        </div>

        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        const modeBtns = document.querySelectorAll('.mode-btn');
        const modeContents = document.querySelectorAll('.mode-content');
        
        modeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;
                modeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                modeContents.forEach(content => content.classList.remove('active'));
                document.getElementById(mode + '-mode').classList.add('active');
                
                tooltip.classList.remove('show');
            });
        });

        let mediaRecorder, audioChunks = [], isListening = false;
        let recordingStartTime, timerInterval;
        let recognition = null;
        let finalTranscript = '';
        let interimTranscript = '';
        
        const phraseInput = document.getElementById('phraseInput');
        const checkBtn = document.getElementById('checkBtn');
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const listenBtn = document.getElementById('listenBtn');
        const pronunciationResult = document.getElementById('pronunciationResult');
        const pronunciationError = document.getElementById('pronunciationError');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const listeningIndicator = document.getElementById('listeningIndicator');
        const recordingTimer = document.getElementById('recordingTimer');
        const liveTranscript = document.getElementById('liveTranscript');
        const transcriptText = document.getElementById('transcriptText');

        listenBtn.addEventListener('click', listenToModel);
        recordBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);
        checkBtn.addEventListener('click', checkPronunciation);

        function listenToModel() {
            const phrase = phraseInput.value.trim();
            if (!phrase) { showPronunciationError('Please enter a phrase first!'); return; }
            if (isListening) {
                window.speechSynthesis.cancel();
                isListening = false;
                listenBtn.textContent = 'üîä Listen to Model';
                listenBtn.className = 'btn-listen';
                listeningIndicator.classList.remove('active');
                return;
            }
            isListening = true;
            listenBtn.textContent = '‚èπÔ∏è Stop Audio';
            listenBtn.className = 'btn-secondary';
            listeningIndicator.classList.add('active');
            pronunciationResult.classList.remove('show');
            pronunciationError.classList.remove('show');
            const utterance = new SpeechSynthesisUtterance(phrase);
            utterance.lang = 'en-US';
            utterance.rate = 0.8;
            utterance.onend = () => {
                isListening = false;
                listenBtn.textContent = 'üîä Listen to Model';
                listenBtn.className = 'btn-listen';
                listeningIndicator.classList.remove('active');
            };
            window.speechSynthesis.speak(utterance);
        }

        async function startRecording() {
            const phrase = phraseInput.value.trim();
            if (!phrase) { showPronunciationError('Please enter a phrase first!'); return; }
            
            finalTranscript = '';
            interimTranscript = '';
            transcriptText.textContent = 'Waiting for speech...';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => { audioChunks.push(event.data); };
                mediaRecorder.onstop = () => {
                    stream.getTracks().forEach(track => track.stop());
                };
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    showPronunciationError('Speech Recognition not supported in this browser. Please use Chrome or Edge.');
                    return;
                }
                
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.continuous = true;
                recognition.interimResults = true;
                
                recognition.onresult = (event) => {
                    interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    const displayText = (finalTranscript + interimTranscript).trim();
                    transcriptText.textContent = displayText || 'Listening...';
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if (event.error === 'no-speech') {
                        transcriptText.textContent = 'No speech detected. Please speak louder.';
                    }
                };
                
                mediaRecorder.start();
                recognition.start();
                
                recordBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                recordingIndicator.classList.add('active');
                liveTranscript.classList.add('active');
                pronunciationResult.classList.remove('show');
                pronunciationError.classList.remove('show');
                
                recordingStartTime = Date.now();
                timerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const secs = (elapsed % 60).toString().padStart(2, '0');
                    recordingTimer.textContent = mins + ':' + secs;
                }, 1000);
            } catch (error) {
                showPronunciationError('Could not access microphone: ' + error.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
            
            clearInterval(timerInterval);
            recordBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            recordingIndicator.classList.remove('active');
            
            setTimeout(() => {
                liveTranscript.classList.remove('active');
            }, 1000);
        }

        async function checkPronunciation() {
            const phrase = phraseInput.value.trim();
            if (!phrase) { showPronunciationError('Please enter a phrase'); return; }
            
            const transcribedText = finalTranscript.trim();
            
            if (!transcribedText) { 
                showPronunciationError('No speech detected! Please record your voice and speak clearly.'); 
                return; 
            }

            pronunciationResult.classList.remove('show');
            pronunciationError.classList.remove('show');
            checkBtn.disabled = true;
            recordBtn.disabled = true;
            listenBtn.disabled = true;
            pronunciationResult.innerHTML = '<div class="loading">ü§î Analyzing pronunciation...</div>';
            pronunciationResult.classList.add('show');

            try {
                const analysis = analyzePronunciation(phrase, transcribedText);
                displayFeedback(phrase, transcribedText, analysis);
            } catch (err) {
                pronunciationResult.classList.remove('show');
                showPronunciationError(err.message);
            } finally {
                checkBtn.disabled = false;
                recordBtn.disabled = false;
                listenBtn.disabled = false;
            }
        }

        function analyzePronunciation(expected, actual) {
            const normalizeText = (text) => {
                return text.toLowerCase()
                    .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?"']/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            };
            
            const expectedNorm = normalizeText(expected);
            const actualNorm = normalizeText(actual);
            
            const expectedWords = expectedNorm.split(/\s+/).filter(w => w.length > 0);
            const actualWords = actualNorm.split(/\s+/).filter(w => w.length > 0);
            
            const analysis = { correct: 0, incorrect: 0, missing: 0, words: [] };

            const actualWordMap = new Map();
            actualWords.forEach((word, idx) => {
                if (!actualWordMap.has(word)) {
                    actualWordMap.set(word, []);
                }
                actualWordMap.get(word).push(idx);
            });

            const usedIndices = new Set();

            expectedWords.forEach((expectedWord) => {
                let status = 'missing';
                let matchedWord = '';
                
                if (actualWordMap.has(expectedWord)) {
                    const indices = actualWordMap.get(expectedWord);
                    const availableIdx = indices.find(idx => !usedIndices.has(idx));
                    if (availableIdx !== undefined) {
                        status = 'correct';
                        matchedWord = expectedWord;
                        usedIndices.add(availableIdx);
                        analysis.correct++;
                    }
                }
                
                if (status === 'missing') {
                    let bestMatch = null;
                    let bestDistance = Infinity;
                    let bestIdx = -1;
                    
                    actualWords.forEach((actualWord, idx) => {
                        if (!usedIndices.has(idx)) {
                            const distance = levenshteinDistance(expectedWord, actualWord);
                            const maxLength = Math.max(expectedWord.length, actualWord.length);
                            const threshold = Math.max(1, Math.floor(maxLength * 0.25));
                            
                            if (distance <= threshold && distance < bestDistance) {
                                bestMatch = actualWord;
                                bestDistance = distance;
                                bestIdx = idx;
                            }
                        }
                    });
                    
                    if (bestMatch) {
                        status = 'incorrect';
                        matchedWord = bestMatch;
                        usedIndices.add(bestIdx);
                        analysis.incorrect++;
                    } else {
                        analysis.missing++;
                    }
                }
                
                analysis.words.push({ 
                    expected: expectedWord, 
                    actual: matchedWord || '', 
                    status: status 
                });
            });

            const totalWords = expectedWords.length;
            analysis.accuracy = totalWords > 0 ? Math.round((analysis.correct / totalWords) * 100) : 0;
            
            return analysis;
        }

        function levenshteinDistance(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        function displayFeedback(expected, actual, analysis) {
            const scoreColor = analysis.accuracy >= 80 ? '#28a745' : analysis.accuracy >= 60 ? '#ffc107' : '#dc3545';
            let html = '<div class="feedback-container">';
            html += `<div class="accuracy-score" style="background: ${scoreColor};"><h2>${analysis.accuracy}%</h2><p>Pronunciation Accuracy</p></div>`;
            html += '<h3 style="margin-bottom: 15px;">üìä Word-by-Word Analysis:</h3><div class="word-analysis">';
            
            analysis.words.forEach(word => {
                let className = 'word-box ', statusIcon = '', tooltip = '';
                if (word.status === 'correct') {
                    className += 'word-correct'; 
                    statusIcon = ' ‚úì';
                } else if (word.status === 'incorrect') {
                    className += 'word-incorrect'; 
                    statusIcon = ' ‚úó';
                    tooltip = ` title="You said: ${word.actual}"`;
                } else {
                    className += 'word-missing'; 
                    statusIcon = ' ?';
                    tooltip = ' title="Not detected"';
                }
                html += `<div class="${className}"${tooltip}>${word.expected}${status
